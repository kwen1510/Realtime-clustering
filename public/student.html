<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Student Response</title>
  <style>

    :root {
      color-scheme: light;
      font-family: "Inter", "Segoe UI", system-ui, sans-serif;
      --bg-top: #f7faff;
      --bg-bottom: #eef2ff;
      --surface: #ffffff;
      --surface-muted: #f3f6ff;
      --border: rgba(59, 130, 246, 0.28);
      --shadow-soft: 0 32px 60px -35px rgba(30, 64, 175, 0.45);
      --accent: #2563eb;
      --accent-hover: #1d4ed8;
      --accent-soft: rgba(37, 99, 235, 0.16);
      --text: #0f172a;
      --text-muted: #475569;
      --danger: #dc2626;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: clamp(32px, 6vw, 72px);
      background: linear-gradient(180deg, var(--bg-top) 0%, var(--bg-bottom) 100%);
      color: var(--text);
    }

    main { width: min(640px, 100%); }

    .card {
      background: var(--surface);
      border-radius: 32px;
      padding: clamp(34px, 6vw, 50px);
      border: 1px solid var(--border);
      box-shadow: var(--shadow-soft);
      display: grid;
      gap: clamp(26px, 4vw, 34px);
    }

    .stack { display: grid; gap: 24px; }
    .stack-sm { display: grid; gap: 16px; }

    h1 {
      margin: 0;
      font-size: clamp(2rem, 3vw, 2.55rem);
      letter-spacing: -0.02em;
      color: var(--text);
    }

    h2 { margin: 0; font-size: 1.55rem; color: var(--text); }
    p { margin: 0; }

    label {
      display: block;
      font-size: 0.82rem;
      font-weight: 600;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      margin-bottom: 10px;
      color: rgba(71, 85, 105, 0.9);
    }

    input, textarea, button { font: inherit; }

    input, textarea {
      width: 100%;
      border-radius: 18px;
      border: 1px solid rgba(148, 163, 184, 0.45);
      padding: 15px 18px;
      background: var(--surface-muted);
      color: var(--text);
      transition: border 0.2s ease, box-shadow 0.2s ease, transform 0.18s ease;
    }

    input::placeholder,
    textarea::placeholder {
      color: rgba(100, 116, 139, 0.55);
      letter-spacing: 0.01em;
    }

    input:focus,
    textarea:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-soft);
      background: #ffffff;
      transform: translateY(-1px);
    }

    textarea { min-height: 210px; resize: vertical; }

    button {
      border: none;
      border-radius: 999px;
      padding: 14px 26px;
      font-weight: 600;
      color: #ffffff;
      background: linear-gradient(135deg, var(--accent), #3b82f6);
      box-shadow: 0 22px 40px -24px rgba(37, 99, 235, 0.55);
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: transform 0.18s ease, box-shadow 0.18s ease, filter 0.18s ease;
    }

    button:hover:not(:disabled) {
      transform: translateY(-2px);
      filter: saturate(1.12);
      box-shadow: 0 26px 46px -24px rgba(37, 99, 235, 0.6);
    }

    button:disabled {
      opacity: 0.55;
      cursor: not-allowed;
      box-shadow: none;
    }

    .status {
      font-size: 0.95rem;
      color: var(--text-muted);
      display: inline-flex;
      align-items: center;
      gap: 10px;
      margin-top: 12px;
      padding: 10px 16px;
      border-radius: 999px;
      background: rgba(226, 232, 240, 0.7);
      border: 1px solid rgba(148, 163, 184, 0.4);
    }

    .status::before {
      content: "";
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: var(--accent);
      box-shadow: 0 0 12px rgba(37, 99, 235, 0.55);
      animation: pulse 1.8s ease-in-out infinite;
    }

    .status.muted {
      background: rgba(226, 232, 240, 0.55);
      border-color: rgba(148, 163, 184, 0.35);
      color: var(--text-muted);
    }

    .status.muted::before {
      background: rgba(59, 130, 246, 0.55);
      box-shadow: 0 0 8px rgba(59, 130, 246, 0.35);
    }

    .status.error {
      color: var(--danger);
      background: rgba(254, 226, 226, 0.75);
      border-color: rgba(248, 113, 113, 0.55);
    }

    .status.error::before {
      background: var(--danger);
      box-shadow: 0 0 12px rgba(220, 38, 38, 0.6);
    }

        .status-dot {
      display: inline-flex;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: linear-gradient(135deg, #60a5fa, #2563eb);
      box-shadow: 0 0 12px rgba(37, 99, 235, 0.45);
    }

@keyframes pulse {
      0%, 100% { transform: scale(0.85); opacity: 0.7; }
      50% { transform: scale(1.05); opacity: 1; }
    }

    .tip {
      background: rgba(226, 232, 240, 0.7);
      border-radius: 22px;
      padding: 20px 22px;
      color: var(--text-muted);
      line-height: 1.6;
      border: 1px solid rgba(148, 163, 184, 0.35);
    }

    .feedback {
      background: rgba(191, 219, 254, 0.55);
      border-radius: 20px;
      padding: 20px;
      border: 1px solid rgba(147, 197, 253, 0.45);
      color: #1e3a8a;
      line-height: 1.6;
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.6);
    }

    .hidden { display: none !important; }

    .session-tag {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 14px;
      border-radius: 999px;
      background: rgba(37, 99, 235, 0.12);
      color: var(--accent);
      font-size: 0.95rem;
      font-weight: 600;
      letter-spacing: 0.02em;
    }

    @media (max-width: 1024px) {
      body { padding: clamp(26px, 5vw, 52px); }
      main { width: min(720px, 100%); }
      .card { padding: clamp(30px, 5vw, 46px); border-radius: 28px; }
    }

    @media (max-width: 768px) {
      .card { gap: 24px; }
      .stack { gap: 20px; }
    }

    @media (max-width: 640px) {
      body { padding: 24px 16px; }
      .card { padding: 26px 22px; border-radius: 22px; }
      button { width: 100%; justify-content: center; }
    }
</style>
  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.0/+esm";

    const cfg = await fetch("/config").then(r => r.json());
    const supabase = createClient(cfg.SUPABASE_URL, cfg.SUPABASE_ANON_KEY);

    const params = new URLSearchParams(window.location.search);
    const sessionParam = (params.get("session") || "").trim();

    const loginForm = document.getElementById("loginForm");
    const sessionInput = document.getElementById("session");
    const nameInput = document.getElementById("loginName");
    const loginError = document.getElementById("loginError");
    const loginStatus = document.getElementById("loginStatus");
    const editorPanel = document.getElementById("editorPanel");
    const loginPanel = document.getElementById("loginPanel");
    const answerInput = document.getElementById("answer");
    const statusEl = document.getElementById("status");
    const feedbackBox = document.getElementById("feedbackBox");
    const feedbackText = document.getElementById("feedbackText");

    if (sessionParam) {
      sessionInput.value = sessionParam;
      if (loginStatus) {
        const statusText = loginStatus.querySelector('span[data-role="status-text"]');
        if (statusText) statusText.textContent = 'Session code prefilled from URL. You can change it.';
      }
    } else {
      if (loginStatus) {
        const statusText = loginStatus.querySelector('span[data-role="status-text"]');
        if (statusText) statusText.textContent = 'Add ?session=CODE to the URL or enter it below.';
      }
    }

    function showLoginError(message) {
      loginError.textContent = message;
      if (message) {
        loginError.classList.remove("hidden");
      } else {
        loginError.classList.add("hidden");
      }
    }

    let channel = null;
    let subscribed = false;
    let lastBroadcast = 0;
    let lastContent = "";
    let studentName = "";
    let sessionCode = "";

    function toChannelName(session) {
      return `realtime_class_${session.replace(/[^a-zA-Z0-9_-]/g, "-")}`;
    }

    function resetEditors(){
      answerInput.value = "";
      statusEl.textContent = "Connected — your teacher sees updates as you type.";
      statusEl.classList.remove("error");
      lastBroadcast = 0;
      lastContent = "";
      feedbackBox.classList.add("hidden");
      feedbackText.textContent = "";
    }

    async function connectChannel(){
      if (channel) {
        try { channel.unsubscribe(); } catch (err) { console.error(err); }
        channel = null;
      }
      subscribed = false;
      const name = toChannelName(sessionCode);
      channel = supabase.channel(name)
        .on("broadcast", { event: "feedback" }, ({ payload }) => {
          if (!payload) return;
          if (payload.student && studentName && payload.student.trim().toLowerCase() !== studentName.trim().toLowerCase()) return;
          if (typeof payload.feedback === "string" && payload.feedback.trim()) {
            feedbackText.textContent = payload.feedback.trim();
            feedbackBox.classList.remove("hidden");
          }
        });
      return new Promise(resolve => {
        channel.subscribe(status => {
          if (status === "SUBSCRIBED") {
            subscribed = true;
            statusEl.textContent = "Connected — your teacher sees updates as you type.";
            statusEl.classList.remove("error");
            resolve();
          }
        });
      });
    }

    async function broadcastTyping(){
      if (!channel || !subscribed) return;
      const content = answerInput.value;
      const now = Date.now();
      if (content === lastContent && now - lastBroadcast < 900) return;
      lastContent = content;
      lastBroadcast = now;
      try {
        await channel.send({ type: "broadcast", event: "typing", payload: { session: sessionCode, student: studentName, content, ts: now } });
      } catch (err) {
        console.error("Typing broadcast failed", err);
        statusEl.textContent = "Connection hiccup — trying again.";
        statusEl.classList.add("error");
      }
    }

    // No final save — only live typing per requirements.

    loginForm.addEventListener("submit", async e => {
      e.preventDefault();
      showLoginError("");
      const desiredSessionRaw = sessionInput.value.trim();
      const desiredName = nameInput.value.trim();
      if (!desiredSessionRaw || !desiredName){
        showLoginError("Enter both session code and name.");
        return;
      }
      if (sessionParam && desiredSessionRaw.toLowerCase() !== sessionParam.toLowerCase()){
        showLoginError(`Session code must match ${sessionParam}.`);
        return;
      }
      sessionCode = sessionParam ? sessionParam : desiredSessionRaw;
      studentName = desiredName;
      loginPanel.classList.add("hidden");
      editorPanel.classList.remove("hidden");
      resetEditors();
      statusEl.textContent = "Connecting…";
      statusEl.classList.remove("error");
      await connectChannel();
      try {
        await channel.send({ type: "broadcast", event: "join", payload: { session: sessionCode, student: studentName, ts: Date.now() } });
      } catch (err) {
        console.error("Join broadcast failed", err);
      }
      await channel.send({ type: "broadcast", event: "join", payload: { session: sessionCode, student: studentName, ts: Date.now() } });
      await channel.send({ type: "broadcast", event: "typing", payload: { session: sessionCode, student: studentName, content: "", ts: Date.now() } });
      await broadcastTyping();
    });

    nameInput.addEventListener("input", () => {
      showLoginError("");
    });

    sessionInput.addEventListener("input", () => {
      showLoginError("");
      if (sessionParam) {
        }
    });

    answerInput.addEventListener("input", () => { broadcastTyping(); });

    window.addEventListener("beforeunload", () => { if (channel) channel.unsubscribe(); });
  </script>
</head>
<body>
  <main class="card">
    <section id="loginPanel" class="stack">
      <header class="stack">
        <div style="display: flex; align-items: center; justify-content: space-between;">
          <h1 style="margin: 0;">Join your session</h1>
          <span class="status-dot" aria-hidden="true"></span>
        </div>
        <p class="tip">Enter the session code from your teacher and your name to begin. Your teacher will see your thinking live as you type.</p>
      <form id="loginForm" class="stack">
        <div>
          <label for="session">Session code</label>
          <input id="session" placeholder="e.g. ABC123" autocomplete="off" />
        </div>
        <div>
          <label for="loginName">Your name</label>
          <input id="loginName" placeholder="e.g. Sam Carter" autocomplete="off" />
        </div>
        <button type="submit">Enter session</button>
        <span id="loginError" class="status error hidden"></span>
      </form>
    </section>

    <section id="editorPanel" class="stack hidden">
      <header class="stack">
          <h2>Share your answer</h2>
        <p class="tip">We update your teacher instantly—pause for a moment when you finish typing.</p>
      </header>
      <div>
        <label for="answer">Your answer</label>
        <textarea id="answer" placeholder="Type your response…"></textarea>
      </div>
      <p id="status" class="status">Connecting…</p>
      <div id="feedbackBox" class="feedback hidden">
        <strong>Teacher feedback</strong>
        <p id="feedbackText" style="margin:8px 0 0"></p>
      </div>
    </section>
  </main>
</body>
</html>
